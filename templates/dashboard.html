<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextGen IDS - AI-Powered Intrusion Detection</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --critical: #dc2626;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-card) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-card-hover) 100%);
            padding: 1.5rem 2rem;
            border-bottom: 3px solid var(--primary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
        }

        .header .subtitle {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .header-badge {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px var(--success);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Navigation Tabs */
        .tabs {
            background: linear-gradient(180deg, #1e293b 0%, #172033 100%);
            padding: 1rem 2rem;
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .tab {
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            background: transparent;
            border: 1px solid transparent;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #e2e8f0;
            border-color: rgba(59, 130, 246, 0.3);
        }

        .tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        /* Container */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: linear-gradient(145deg, #1e293b 0%, #1a2332 100%);
            border-radius: 16px;
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(59, 130, 246, 0.1);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .card h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: #f1f5f9;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .card h3 {
            font-size: 1rem;
            margin-bottom: 0.75rem;
            color: #cbd5e1;
        }

        /* Grid Layouts */
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }

        /* Stat Cards */
        .stat-card {
            background: linear-gradient(145deg, #1e293b 0%, #253344 100%);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 16px;
            padding: 1.75rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), transparent);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(59, 130, 246, 0.2);
            border-color: var(--primary);
        }

        .stat-card h3 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            color: #3b82f6;
            text-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }

        .stat-card p {
            color: #94a3b8;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        .stat-card.critical h3 { color: #ef4444; text-shadow: 0 2px 10px rgba(239, 68, 68, 0.3); }
        .stat-card.critical::before { background: linear-gradient(90deg, #ef4444, transparent); }
        .stat-card.high h3 { color: #f59e0b; text-shadow: 0 2px 10px rgba(245, 158, 11, 0.3); }
        .stat-card.high::before { background: linear-gradient(90deg, #f59e0b, transparent); }
        .stat-card.medium h3 { color: #eab308; }
        .stat-card.low h3 { color: #10b981; text-shadow: 0 2px 10px rgba(16, 185, 129, 0.3); }
        .stat-card.low::before { background: linear-gradient(90deg, #10b981, transparent); }

        /* Form Controls */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #cbd5e1;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.875rem 1rem;
            border-radius: 10px;
            border: 1px solid #334155;
            background: rgba(15, 23, 42, 0.8);
            color: #e2e8f0;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        .btn-success:hover { 
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        .btn-danger { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        .btn-danger:hover { 
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }
        .btn-secondary { 
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            box-shadow: 0 2px 8px rgba(100, 116, 139, 0.3);
        }
        .btn-secondary:hover { 
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            box-shadow: 0 6px 20px rgba(100, 116, 139, 0.4);
        }

        /* Alert Boxes */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid;
            backdrop-filter: blur(10px);
        }

        .alert-info { background: rgba(30, 58, 95, 0.8); border-color: #3b82f6; }
        .alert-success { background: rgba(30, 58, 47, 0.8); border-color: #10b981; }
        .alert-warning { background: rgba(58, 46, 30, 0.8); border-color: #f59e0b; }
        .alert-danger { background: rgba(58, 30, 30, 0.8); border-color: #ef4444; }

        /* Threat Feed */
        .threat-feed {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .threat-item {
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.9) 100%);
            border: 1px solid rgba(51, 65, 85, 0.6);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .threat-item:hover {
            border-color: var(--primary);
            transform: translateX(6px);
            box-shadow: -4px 0 12px rgba(59, 130, 246, 0.2);
        }

        .threat-info h4 {
            font-size: 0.95rem;
            margin-bottom: 0.35rem;
            color: #f1f5f9;
            font-weight: 600;
        }

        .threat-info p {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .threat-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .badge-critical { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .badge-high { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .badge-medium { background: linear-gradient(135deg, #eab308, #ca8a04); color: #1e293b; }
        .badge-low { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .badge-normal { background: linear-gradient(135deg, #64748b, #475569); color: white; }

        /* Table */
        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1rem;
            border-radius: 12px;
            overflow: hidden;
        }

        .table th {
            background: linear-gradient(135deg, #334155 0%, #3d4f65 100%);
            padding: 1rem;
            text-align: left;
            font-size: 0.8rem;
            font-weight: 700;
            color: #f1f5f9;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .table th:first-child {
            border-top-left-radius: 12px;
        }

        .table th:last-child {
            border-top-right-radius: 12px;
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            font-size: 0.875rem;
            background: rgba(15, 23, 42, 0.4);
        }

        .table tr:hover td {
            background: rgba(59, 130, 246, 0.1);
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .table tr:last-child td:first-child {
            border-bottom-left-radius: 12px;
        }

        .table tr:last-child td:last-child {
            border-bottom-right-radius: 12px;
        }

        /* Progress Bar */
        .progress {
            background: linear-gradient(135deg, #1e293b, #334155);
            border-radius: 12px;
            height: 28px;
            overflow: hidden;
            margin: 1rem 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .progress-bar {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            transition: width 0.5s ease;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }

        /* Chart Container */
        .chart-container {
            background: #0f172a;
            border-radius: 8px;
            padding: 1rem;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed #334155;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #3b82f6;
            background: #0f172a;
        }

        .file-upload.drag-over {
            border-color: #3b82f6;
            background: #1e3a5f;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #334155;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results */
        .result-box {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #334155;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .result-value {
            color: #f1f5f9;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* Confidence Meter */
        .confidence-meter {
            width: 100%;
            height: 8px;
            background: #334155;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #64748b;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
            .tabs {
                padding: 0.5rem 1rem;
            }
            .tab {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div>
                <h1>
                    üõ°Ô∏è NextGen IDS
                </h1>
                <div class="subtitle">AI-Powered Intrusion Detection & Prevention System</div>
            </div>
            <div class="header-badge">
                <span class="status-indicator"></span>
                System Active
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
        <button class="tab" onclick="switchTab('analysis')">üîç Traffic Analysis</button>
        <button class="tab" onclick="switchTab('converter')">üîÑ Dataset Converter</button>
        <button class="tab" onclick="switchTab('phishing')">üé£ Phishing Detection</button>
        <button class="tab" onclick="switchTab('logs')">üìã Log Analysis</button>
        <button class="tab" onclick="switchTab('training')">üß† Model Training</button>
        <button class="tab" onclick="switchTab('remediation')">‚ö° Remediation</button>
        <button class="tab" onclick="switchTab('blockchain')">üîó Audit Chain</button>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <!-- Statistics Cards -->
            <div class="grid-4">
                <div class="stat-card">
                    <h3 id="stat-total">0</h3>
                    <p>Total Threats</p>
                </div>
                <div class="stat-card critical">
                    <h3 id="stat-critical">0</h3>
                    <p>Critical</p>
                </div>
                <div class="stat-card high">
                    <h3 id="stat-high">0</h3>
                    <p>High</p>
                </div>
                <div class="stat-card low">
                    <h3 id="stat-active">0</h3>
                    <p>Active Threats</p>
                </div>
            </div>

            <!-- Live Threat Feed -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>üö® Live Threat Feed</h2>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="liveUpdatesToggle" checked onchange="toggleLiveUpdates()" style="cursor: pointer;">
                        <span style="color: #94a3b8; font-size: 0.875rem;">Live Updates</span>
                    </label>
                </div>
                <div id="live-feed" class="threat-feed">
                    <div class="empty-state">
                        <p>No threats detected. System is monitoring...</p>
                    </div>
                </div>
            </div>

            <!-- Recent Threats Table -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>üìë Recent Threat Activity</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-danger" onclick="clearAllThreats()">üóëÔ∏è Clear All</button>
                        <button class="btn btn-secondary" onclick="loadRecentThreats()">üîÑ Refresh</button>
                    </div>
                </div>
                <div id="recent-threats-container"></div>
            </div>
                <!-- IP Analysis Card -->
                <div class="card">
                    <h2>üîé IP Analysis</h2>
                    <div class="form-group">
                        <label>Enter IP address to search threats</label>
                        <input type="text" id="ip-analysis-input" class="form-control" placeholder="e.g. 192.168.1.1">
                    </div>
                    <button class="btn" onclick="analyzeIPThreats()">üîç Analyze IP</button>
                    <div id="ip-analysis-result"></div>
                </div>

            <!-- Realtime Detection Card -->
            <div class="card">
                <h2>üõ∞Ô∏è Start Realtime Detection</h2>
                <div class="form-group">
                    <label>Network Interface (e.g. Ethernet, Wi-Fi)</label>
                    <input type="text" id="realtime-iface" class="form-control" placeholder="Ethernet">
                </div>
                <div class="form-group">
                    <label>Window (seconds)</label>
                    <input type="number" id="realtime-window" class="form-control" value="2" min="1" max="10">
                </div>
                <button class="btn" onclick="startRealtimeDetection()">üöÄ Start Realtime Detection</button>
                <div id="realtime-result" style="margin-top:1rem;"></div>
                <small style="color:#94a3b8;display:block;margin-top:0.5rem;">Requires Npcap (Windows) and admin rights. See User Guide for details.</small>
            </div>
        </div>

        <!-- Traffic Analysis Tab -->
        <div id="analysis" class="tab-content">
            <div class="card">
                <h2>üîç Upload Traffic for Analysis</h2>
                <div class="form-group">
                    <label>Select CSV or PCAP File</label>
                    <input type="file" id="traffic-file" class="form-control" accept=".csv,.pcap,.pcapng">
                </div>
                <button class="btn" onclick="analyzeTraffic()">üöÄ Analyze Traffic</button>
            </div>

            <div id="analysis-result"></div>
        </div>

        <!-- Phishing Detection Tab -->
        <div id="phishing" class="tab-content">
            <div class="grid-2">
                <!-- URL Scanner -->
                <div class="card">
                    <h2>üîó URL Scanner</h2>
                    <div class="form-group">
                        <label>Enter URL to analyze</label>
                        <input type="text" id="phishing-url" class="form-control" placeholder="https://example.com">
                    </div>
                    <button class="btn" onclick="checkPhishingURL()">üîé Scan URL</button>
                    <div id="url-result"></div>
                </div>

                <!-- Email Scanner -->
                <div class="card">
                    <h2>üìß Email Scanner</h2>
                    <div class="form-group">
                        <label>Paste email content</label>
                        <textarea id="phishing-email" class="form-control" placeholder="Paste email content here..."></textarea>
                    </div>
                    <button class="btn" onclick="checkPhishingEmail()">üîé Scan Email</button>
                    <div id="email-result"></div>
                </div>
            </div>
        </div>

        <!-- Dataset Converter Tab -->
        <div id="converter" class="tab-content">
            <div class="card">
                <h2>üîÑ Dataset Converter</h2>
                <p style="color: #94a3b8; margin-bottom: 1.5rem;">Convert external datasets (KDD, CICIDS, UNSW-NB15) to IoT-23 format for analysis</p>
                
                <div class="info-box" style="background: #1e293b; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #3b82f6;">
                    <h3 style="margin-bottom: 0.5rem; font-size: 1rem;">‚ÑπÔ∏è How It Works</h3>
                    <ul style="color: #94a3b8; font-size: 0.875rem; line-height: 1.6; margin-left: 1.5rem;">
                        <li>Upload any network traffic dataset (CSV format)</li>
                        <li>Auto-detects format: KDD, CICIDS2017, UNSW-NB15, or Generic</li>
                        <li>Converts to IoT-23 format (20 features) for model compatibility</li>
                        <li>Download converted file and upload to Traffic Analysis tab</li>
                    </ul>
                </div>

                <div style="background: #1e293b; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h3 style="margin-bottom: 1rem;">üìÅ Upload Dataset</h3>
                    
                    <div class="form-group">
                        <label>Select CSV File</label>
                        <input type="file" id="converterFileInput" accept=".csv" class="form-control" style="cursor: pointer;">
                    </div>

                    <div class="form-group">
                        <label>Row Limit (optional, for faster processing)</label>
                        <input type="number" id="converterMaxRows" class="form-control" placeholder="e.g., 5000">
                        <small style="color: #64748b; display: block; margin-top: 0.25rem;">Leave empty to convert entire dataset</small>
                    </div>

                    <button class="btn" onclick="convertDataset()" style="width: 100%;">
                        üîÑ Convert to IoT-23 Format
                    </button>

                    <div id="converter-result" style="margin-top: 1.5rem;"></div>
                </div>

                <div style="background: #1e293b; padding: 1.5rem; border-radius: 8px; border: 1px solid #334155;">
                    <h3 style="margin-bottom: 1rem;">üìä Supported Formats</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="padding: 0.75rem; background: #0f172a; border-radius: 6px;">
                            <div style="font-weight: 600; color: #3b82f6;">KDD Cup 99</div>
                            <div style="font-size: 0.75rem; color: #64748b;">41-42 columns</div>
                        </div>
                        <div style="padding: 0.75rem; background: #0f172a; border-radius: 6px;">
                            <div style="font-weight: 600; color: #10b981;">CICIDS2017</div>
                            <div style="font-size: 0.75rem; color: #64748b;">Flow-based features</div>
                        </div>
                        <div style="padding: 0.75rem; background: #0f172a; border-radius: 6px;">
                            <div style="font-weight: 600; color: #f59e0b;">UNSW-NB15</div>
                            <div style="font-size: 0.75rem; color: #64748b;">49 columns</div>
                        </div>
                        <div style="padding: 0.75rem; background: #0f172a; border-radius: 6px;">
                            <div style="font-weight: 600; color: #8b5cf6;">Generic CSV</div>
                            <div style="font-size: 0.75rem; color: #64748b;">Any format</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Log Analysis Tab -->
        <div id="logs" class="tab-content">
            <div class="card">
                <h2>üìã System Log Analysis</h2>
                <div class="form-group">
                    <label>Log Source</label>
                    <select id="log-source" class="form-control">
                        <option value="syslog">Syslog</option>
                        <option value="windows">Windows Event Log</option>
                        <option value="apache">Apache</option>
                        <option value="nginx">Nginx</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Paste Log Lines (one per line)</label>
                    <textarea id="log-content" class="form-control" rows="10" placeholder="Paste log entries here..."></textarea>
                </div>
                <button class="btn" onclick="analyzeLogs()">üîç Analyze Logs</button>
                <div id="log-result"></div>
            </div>
        </div>

        <!-- Model Training Tab -->
        <div id="training" class="tab-content">
            <div class="grid-2">
                <!-- Training -->
                <div class="card">
                    <h2>üß† Train Model</h2>
                    
                    <div class="form-group">
                        <label>Training Data Source</label>
                        <select id="train-source" class="form-control" onchange="toggleTrainingDataSource()">
                            <option value="built-in">Built-in Dataset (IoT-23)</option>
                            <option value="upload">Upload Custom Dataset</option>
                        </select>
                    </div>

                    <div id="train-builtin-options">
                        <div class="form-group">
                            <label>Dataset</label>
                            <input type="text" id="train-dataset" class="form-control" value="iot23" placeholder="iot23" readonly>
                        </div>
                    </div>

                    <div id="train-upload-options" style="display: none;">
                        <div class="form-group">
                            <label>Upload Training CSV</label>
                            <input type="file" id="train-file" class="form-control" accept=".csv">
                            <small style="color: #94a3b8; display: block; margin-top: 0.5rem;">
                                <strong>‚ú® Smart CSV Support:</strong> Upload any network traffic CSV! The system will automatically:
                                <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                    <li>Detect and map common column name variations</li>
                                    <li>Generate missing features with synthetic data</li>
                                    <li>Handle different dataset formats (CIC-IDS, IoT-23, NSL-KDD, etc.)</li>
                                </ul>
                                Just make sure your CSV has a <strong>label/class/attack</strong> column for supervised learning!
                            </small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Epochs</label>
                        <input type="number" id="train-epochs" class="form-control" value="5" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>Batch Size</label>
                        <input type="number" id="train-batch" class="form-control" value="32" min="8" max="256">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="train-arnn"> Use Advanced A-RNN Model
                        </label>
                    </div>
                    <button class="btn" onclick="trainModel()">üöÄ Start Training</button>
                    <div id="training-progress"></div>
                </div>

                <!-- Evaluation -->
                <div class="card">
                    <h2>üìä Evaluate Model</h2>
                    
                    <div class="form-group">
                        <label>Test Data Source</label>
                        <select id="eval-source" class="form-control" onchange="toggleEvalDataSource()">
                            <option value="built-in">Built-in Dataset (IoT-23)</option>
                            <option value="upload">Upload Custom Test Data</option>
                        </select>
                    </div>

                    <div id="eval-builtin-options">
                        <div class="form-group">
                            <label>Dataset</label>
                            <input type="text" id="eval-dataset" class="form-control" value="iot23" readonly>
                        </div>
                    </div>

                    <div id="eval-upload-options" style="display: none;">
                        <div class="form-group">
                            <label>Upload Test CSV</label>
                            <input type="file" id="eval-file" class="form-control" accept=".csv">
                            <small style="color: #94a3b8; display: block; margin-top: 0.5rem;">
                                <strong>‚ú® Smart CSV Support:</strong> The system automatically handles different column names and formats.
                                Just ensure your CSV has a <strong>label</strong> column for evaluation metrics.
                            </small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Checkpoint</label>
                        <input type="text" id="eval-checkpoint" class="form-control" value="best_iot23.pt" placeholder="best_iot23.pt">
                    </div>
                    <button class="btn" onclick="evaluateModel()">üìà Evaluate</button>
                    <div id="evaluation-result"></div>
                </div>
            </div>
        </div>

        <!-- Remediation Tab -->
        <div id="remediation" class="tab-content">
            <div class="card">
                <h2>‚ö° Automated Response Actions</h2>
                <button class="btn btn-secondary" onclick="loadRemediationActions()" style="float: right;">üîÑ Refresh</button>
                <div style="clear: both;"></div>
                <div id="remediation-list"></div>
            </div>
        </div>

        <!-- Blockchain Tab -->
        <div id="blockchain" class="tab-content">
            <div class="card">
                <h2>üîó Blockchain Audit Trail</h2>
                <p style="color: #94a3b8; margin-bottom: 1rem;">Tamper-evident logging of all security events</p>
                <button class="btn" onclick="verifyBlockchain()">üîç Verify Chain Integrity</button>
                <div id="blockchain-result"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let eventSource = null;
        let liveUpdatesEnabled = true;
        let stats = {
            total: 0,
            critical: 0,
            high: 0,
            medium: 0,
            low: 0,
            active: 0
        };

        // Toggle training data source
        function toggleTrainingDataSource() {
            const source = document.getElementById('train-source').value;
            const builtinOptions = document.getElementById('train-builtin-options');
            const uploadOptions = document.getElementById('train-upload-options');
            
            if (source === 'built-in') {
                builtinOptions.style.display = 'block';
                uploadOptions.style.display = 'none';
            } else {
                builtinOptions.style.display = 'none';
                uploadOptions.style.display = 'block';
            }
        }

        // Toggle evaluation data source
        function toggleEvalDataSource() {
            const source = document.getElementById('eval-source').value;
            const builtinOptions = document.getElementById('eval-builtin-options');
            const uploadOptions = document.getElementById('eval-upload-options');
            
            if (source === 'built-in') {
                builtinOptions.style.display = 'block';
                uploadOptions.style.display = 'none';
            } else {
                builtinOptions.style.display = 'none';
                uploadOptions.style.display = 'block';
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'dashboard') {
                loadDashboardData();
            } else if (tabName === 'remediation') {
                loadRemediationActions();
            }
        }

        // Initialize dashboard
        function initDashboard() {
            loadDashboardData();
            connectEventStream();
        }

        // Clear all threats from the database
        async function clearAllThreats() {
            if (!confirm('Are you sure you want to clear all threat data? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/dashboard/clear_threats', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    // Reset stats
                    stats = { total: 0, critical: 0, high: 0, medium: 0, low: 0, active: 0 };
                    updateStatCards();
                    
                    // Clear live feed
                    const feed = document.getElementById('live-feed');
                    feed.innerHTML = '<div class="empty-state"><p>No threats detected. System is monitoring...</p></div>';
                    
                    // Clear recent threats table
                    document.getElementById('recent-threats-container').innerHTML = '<div class="empty-state"><p>No recent threats</p></div>';
                    
                    alert('All threat data has been cleared successfully.');
                } else {
                    alert('Failed to clear threats: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error clearing threats: ' + error.message);
            }
        }

        // Load dashboard statistics
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard/stats');
                const data = await response.json();
                
                stats = {
                    total: data.total_threats || 0,
                    critical: data.by_severity?.Critical || 0,
                    high: data.by_severity?.High || 0,
                    medium: data.by_severity?.Medium || 0,
                    low: data.by_severity?.Low || 0,
                    active: data.active_threats || 0
                };

                updateStatCards();
                await loadRecentThreats();
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Update stat cards
        function updateStatCards() {
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-critical').textContent = stats.critical;
            document.getElementById('stat-high').textContent = stats.high;
            document.getElementById('stat-active').textContent = stats.active;
        }

        // Toggle live updates
        function toggleLiveUpdates() {
            liveUpdatesEnabled = document.getElementById('liveUpdatesToggle').checked;
            if (liveUpdatesEnabled) {
                connectEventStream();
            } else {
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            }
        }

        // Connect to Server-Sent Events for live feed
        function connectEventStream() {
            if (!liveUpdatesEnabled) return;
            
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource('/events');
            
            eventSource.onmessage = function(event) {
                if (!liveUpdatesEnabled) return;
                try {
                    const alert = JSON.parse(event.data);
                    addLiveThreat(alert);
                    updateStatsFromAlert(alert);
                } catch (error) {
                    console.error('Failed to parse event:', error);
                }
            };

            eventSource.onerror = function() {
                console.log('Event stream disconnected, reconnecting...');
                setTimeout(connectEventStream, 5000);
            };
        }

        // Add threat to live feed
        function addLiveThreat(alert) {
            const feed = document.getElementById('live-feed');
            
            // Remove empty state
            const emptyState = feed.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const severity = (alert.severity || 'Low').toLowerCase();
            const attackType = alert.attack_type || 'Unknown';
            const confidence = ((alert.confidence || 0) * 100).toFixed(1);
            const timestamp = new Date(alert.timestamp || Date.now()).toLocaleTimeString();

            const threatItem = document.createElement('div');
            threatItem.className = 'threat-item';
            threatItem.innerHTML = `
                <div class="threat-info">
                    <h4>üö® ${attackType}</h4>
                    <p>Detected at ${timestamp} ‚Ä¢ Confidence: ${confidence}%</p>
                </div>
                <span class="threat-badge badge-${severity}">${severity}</span>
            `;

            feed.insertBefore(threatItem, feed.firstChild);

            // Keep only latest 20 items
            while (feed.children.length > 20) {
                feed.removeChild(feed.lastChild);
            }
        }

        // Update stats from incoming alert
        function updateStatsFromAlert(alert) {
            stats.total++;
            const severity = (alert.severity || 'Low').toLowerCase();
            if (severity === 'critical') stats.critical++;
            else if (severity === 'high') stats.high++;
            else if (severity === 'medium') stats.medium++;
            else if (severity === 'low') stats.low++;

            if (alert.attack_type && alert.attack_type !== 'Normal') {
                stats.active++;
            }

            updateStatCards();
        }

        // Load recent threats
        async function loadRecentThreats() {
            try {
                const response = await fetch('/api/dashboard/recent_threats?limit=10');
                const threats = await response.json();
                
                const container = document.getElementById('recent-threats-container');
                
                if (!threats || threats.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No recent threats</p></div>';
                    return;
                }

                let html = '<table class="table"><thead><tr><th>ID</th><th>Attack Type</th><th>Severity</th><th>Confidence</th><th>Timestamp</th><th>Status</th></tr></thead><tbody>';
                
                threats.forEach(threat => {
                    const severity = (threat.severity || 'Low').toLowerCase();
                    const confidence = ((threat.confidence || 0) * 100).toFixed(1);
                    const time = new Date(threat.timestamp).toLocaleString();
                    
                    html += `
                        <tr>
                            <td>#${threat.id}</td>
                            <td>${threat.attack_type}</td>
                            <td><span class="threat-badge badge-${severity}">${threat.severity}</span></td>
                            <td>${confidence}%</td>
                            <td>${time}</td>
                            <td>${threat.status || 'Active'}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Failed to load recent threats:', error);
            }
        }

        // Analyze traffic file
        async function analyzeTraffic() {
            const fileInput = document.getElementById('traffic-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file');
                return;
            }

            const resultDiv = document.getElementById('analysis-result');
            resultDiv.innerHTML = '<div class="card"><div class="spinner"></div><p style="text-align: center;">Analyzing traffic...</p></div>';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/analyze_traffic', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    const pred = result.prediction;
                    const confidence = (pred.confidence * 100).toFixed(1);
                    const severity = pred.severity.toLowerCase();

                    resultDiv.innerHTML = `
                        <div class="card">
                            <h2>‚úÖ Analysis Complete</h2>
                            <div class="result-box">
                                <div class="result-item">
                                    <span class="result-label">Attack Type:</span>
                                    <span class="result-value">${pred.attack_type}</span>
                                </div>
                                <div class="result-item">
                                    <span class="result-label">Severity:</span>
                                    <span class="threat-badge badge-${severity}">${pred.severity}</span>
                                </div>
                                <div class="result-item">
                                    <span class="result-label">Confidence:</span>
                                    <span class="result-value">${confidence}%</span>
                                </div>
                                <div class="result-item">
                                    <span class="result-label">Sequences Analyzed:</span>
                                    <span class="result-value">${result.sequences}</span>
                                </div>
                            </div>
                            ${result.explanation && typeof result.explanation === 'object' ? `
                                <div class="alert alert-info" style="margin-top: 1rem;">
                                    <strong>ü§ñ AI Explanation:</strong><br><br>
                                    <strong>${result.explanation.description || ''}</strong>
                                    ${result.explanation.indicators && result.explanation.indicators.length > 0 ? `
                                        <div style="margin-top: 0.75rem;">
                                            <strong>üìä Indicators:</strong>
                                            <ul style="margin-top: 0.25rem; margin-left: 1.5rem; line-height: 1.6;">
                                                ${result.explanation.indicators.map(i => `<li>${i}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${result.explanation.mitigation_steps && result.explanation.mitigation_steps.length > 0 ? `
                                        <div style="margin-top: 0.75rem;">
                                            <strong>üõ°Ô∏è Recommended Actions:</strong>
                                            <ul style="margin-top: 0.25rem; margin-left: 1.5rem; line-height: 1.6;">
                                                ${result.explanation.mitigation_steps.map(m => `<li>${m}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #334155;">
                                        <span style="color: #94a3b8;">Attack Stage:</span> <strong>${result.explanation.attack_stage || 'Unknown'}</strong> | 
                                        <span style="color: #94a3b8;">Priority:</span> <strong>${result.explanation.recommended_priority || 'MEDIUM'}</strong>
                                    </div>
                                </div>
                            ` : result.explanation ? `
                                <div class="alert alert-info" style="margin-top: 1rem;">
                                    <strong>ü§ñ AI Explanation:</strong><br>${result.explanation}
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Analysis failed: ${error.message}</div>`;
            }
        }

        // Convert dataset to IoT-23 format
        async function convertDataset() {
            const fileInput = document.getElementById('converterFileInput');
            const maxRowsInput = document.getElementById('converterMaxRows');
            const resultDiv = document.getElementById('converter-result');

            if (!fileInput.files.length) {
                alert('Please select a CSV file');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            
            if (maxRowsInput.value) {
                formData.append('max_rows', maxRowsInput.value);
            }

            resultDiv.innerHTML = `
                <div style="padding: 1rem; background: #1e293b; border-radius: 6px; border-left: 4px solid #3b82f6;">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem; color: #94a3b8;">Converting ${file.name}... This may take a moment.</p>
                </div>
            `;

            try {
                const response = await fetch('/api/convert_dataset', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Conversion failed');
                }

                // Download the converted file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `converted_${file.name}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ Conversion Complete!</strong>
                        <p style="margin-top: 0.5rem;">File: <code>converted_${file.name}</code></p>
                        <p style="margin-top: 0.5rem;">The converted file has been downloaded. You can now upload it to the <strong>Traffic Analysis</strong> tab.</p>
                    </div>
                `;

                // Clear inputs
                fileInput.value = '';
                maxRowsInput.value = '';

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Conversion Failed</strong>
                        <p style="margin-top: 0.5rem;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Check phishing URL
        async function checkPhishingURL() {
            const url = document.getElementById('phishing-url').value.trim();
            if (!url) {
                alert('Please enter a URL');
                return;
            }

            const resultDiv = document.getElementById('url-result');
            resultDiv.innerHTML = '<div class="spinner"></div>';

            try {
                const response = await fetch('/api/phishing/url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const result = await response.json();

                if (result.success) {
                    const riskColor = result.risk_score > 70 ? 'danger' : result.risk_score > 40 ? 'warning' : 'success';
                    const severity = (result.severity || 'Low').toLowerCase();

                    let html = `
                        <div class="result-box" style="margin-top: 1rem;">
                            <div class="result-item">
                                <span class="result-label">Category:</span>
                                <span class="result-value">${result.category}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Risk Score:</span>
                                <span class="result-value">${result.risk_score}/100</span>
                            </div>
                            <div class="confidence-meter">
                                <div class="confidence-fill" style="width: ${result.risk_score}%; background: ${result.risk_score > 70 ? '#ef4444' : result.risk_score > 40 ? '#f59e0b' : '#10b981'};"></div>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Verdict:</span>
                                <span class="threat-badge badge-${severity}">${result.is_phishing ? '‚ö†Ô∏è PHISHING' : '‚úÖ SAFE'}</span>
                            </div>
                        </div>
                    `;

                    if (result.indicators && result.indicators.length > 0) {
                        html += '<div class="alert alert-warning" style="margin-top: 1rem;"><strong>Indicators:</strong><ul style="margin-top: 0.5rem;">';
                        result.indicators.forEach(ind => {
                            html += `<li>${ind}</li>`;
                        });
                        html += '</ul></div>';
                    }

                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger" style="margin-top: 1rem;">${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger" style="margin-top: 1rem;">Error: ${error.message}</div>`;
            }
        }

        // Check phishing email
        async function checkPhishingEmail() {
            const content = document.getElementById('phishing-email').value.trim();
            if (!content) {
                alert('Please enter email content');
                return;
            }

            const resultDiv = document.getElementById('email-result');
            resultDiv.innerHTML = '<div class="spinner"></div>';

            try {
                const response = await fetch('/api/phishing/email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                const result = await response.json();

                if (result.success) {
                    const severity = (result.severity || 'Low').toLowerCase();

                    let html = `
                        <div class="result-box" style="margin-top: 1rem;">
                            <div class="result-item">
                                <span class="result-label">Category:</span>
                                <span class="result-value">${result.category}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Risk Score:</span>
                                <span class="result-value">${result.risk_score}/100</span>
                            </div>
                            <div class="confidence-meter">
                                <div class="confidence-fill" style="width: ${result.risk_score}%; background: ${result.risk_score > 70 ? '#ef4444' : result.risk_score > 40 ? '#f59e0b' : '#10b981'};"></div>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Verdict:</span>
                                <span class="threat-badge badge-${severity}">${result.is_phishing ? '‚ö†Ô∏è PHISHING' : '‚úÖ SAFE'}</span>
                            </div>
                        </div>
                    `;

                    if (result.indicators && result.indicators.length > 0) {
                        html += '<div class="alert alert-warning" style="margin-top: 1rem;"><strong>Indicators:</strong><ul style="margin-top: 0.5rem;">';
                        result.indicators.forEach(ind => {
                            html += `<li>${ind}</li>`;
                        });
                        html += '</ul></div>';
                    }

                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger" style="margin-top: 1rem;">${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger" style="margin-top: 1rem;">Error: ${error.message}</div>`;
            }
        }

        // Analyze logs
        async function analyzeLogs() {
            const source = document.getElementById('log-source').value;
            const content = document.getElementById('log-content').value.trim();
            
            if (!content) {
                alert('Please enter log content');
                return;
            }

            const lines = content.split('\n').filter(line => line.trim());
            const resultDiv = document.getElementById('log-result');
            resultDiv.innerHTML = '<div class="spinner"></div>';

            try {
                const response = await fetch('/api/logs/ingest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lines, source })
                });

                const result = await response.json();

                if (result.success) {
                    let html = `<div class="alert alert-success" style="margin-top: 1rem;">Analyzed ${result.events.length} log entries. ${result.threats_added} threats detected.</div>`;
                    
                    if (result.events.length > 0) {
                        html += '<table class="table"><thead><tr><th>Type</th><th>Severity</th><th>Score</th><th>Indicators</th></tr></thead><tbody>';
                        result.events.forEach(evt => {
                            const severity = evt.severity.toLowerCase();
                            html += `
                                <tr>
                                    <td>${evt.type}</td>
                                    <td><span class="threat-badge badge-${severity}">${evt.severity}</span></td>
                                    <td>${evt.score}</td>
                                    <td>${evt.indicators.join(', ')}</td>
                                </tr>
                            `;
                        });
                        html += '</tbody></table>';
                    }

                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger" style="margin-top: 1rem;">${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger" style="margin-top: 1rem;">Error: ${error.message}</div>`;
            }
        }

        // Train model
        async function trainModel() {
            const source = document.getElementById('train-source').value;
            const epochs = parseInt(document.getElementById('train-epochs').value);
            const batchSize = parseInt(document.getElementById('train-batch').value);
            const useArnn = document.getElementById('train-arnn').checked;

            const progressDiv = document.getElementById('training-progress');
            progressDiv.innerHTML = '<div class="progress"><div class="progress-bar" id="train-progress-bar" style="width: 0%;">0%</div></div><p style="margin-top: 1rem;">Training started...</p>';

            try {
                let response;
                
                if (source === 'built-in') {
                    // Use built-in dataset
                    const dataset = document.getElementById('train-dataset').value;
                    response = await fetch('/api/train', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            dataset_name: dataset,
                            epochs: epochs,
                            batch_size: batchSize,
                            use_arnn: useArnn
                        })
                    });
                } else {
                    // Use uploaded file
                    const fileInput = document.getElementById('train-file');
                    if (!fileInput.files.length) {
                        progressDiv.innerHTML = '<div class="alert alert-danger">Please select a CSV file to upload</div>';
                        return;
                    }

                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    formData.append('epochs', epochs);
                    formData.append('batch_size', batchSize);
                    formData.append('use_arnn', useArnn);

                    response = await fetch('/api/train', {
                        method: 'POST',
                        body: formData
                    });
                }

                const result = await response.json();

                if (result.success) {
                    progressDiv.innerHTML = `
                        <div class="alert alert-success">Training complete! Best F1: ${result.best_f1.toFixed(4)}</div>
                        <div class="result-box">
                            <h3>Training History</h3>
                            <table class="table">
                                <thead><tr><th>Epoch</th><th>Train Loss</th><th>Val Accuracy</th><th>Val F1</th></tr></thead>
                                <tbody>
                                    ${result.history.map(h => `
                                        <tr>
                                            <td>${h.epoch}</td>
                                            <td>${h.train_loss.toFixed(4)}</td>
                                            <td>${(h.val_accuracy * 100).toFixed(2)}%</td>
                                            <td>${(h.val_f1 * 100).toFixed(2)}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    progressDiv.innerHTML = `<div class="alert alert-danger">
                        <strong>Training failed:</strong><br>
                        ${result.error}<br>
                        <small style="margin-top: 0.5rem; display: block;">
                            üí° Tip: The system will automatically try to match and generate missing columns. 
                            Check the backend terminal for detailed column mapping information.
                        </small>
                    </div>`;
                }
            } catch (error) {
                progressDiv.innerHTML = `<div class="alert alert-danger">
                    <strong>Error:</strong> ${error.message}<br>
                    <small style="margin-top: 0.5rem; display: block;">
                        Check the backend terminal for detailed error information.
                    </small>
                </div>`;
            }
        }

        // Evaluate model
        async function evaluateModel() {
            const source = document.getElementById('eval-source').value;
            const checkpoint = document.getElementById('eval-checkpoint').value;

            const resultDiv = document.getElementById('evaluation-result');
            resultDiv.innerHTML = '<div class="spinner"></div>';

            try {
                let response;
                
                if (source === 'built-in') {
                    // Use built-in dataset
                    const dataset = document.getElementById('eval-dataset').value;
                    response = await fetch('/api/evaluate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            dataset_name: dataset,
                            checkpoint: checkpoint
                        })
                    });
                } else {
                    // Use uploaded file
                    const fileInput = document.getElementById('eval-file');
                    if (!fileInput.files.length) {
                        resultDiv.innerHTML = '<div class="alert alert-danger">Please select a CSV file to upload</div>';
                        return;
                    }

                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    formData.append('checkpoint', checkpoint);

                    response = await fetch('/api/evaluate', {
                        method: 'POST',
                        body: formData
                    });
                }

                const result = await response.json();

                if (result.success) {
                    const metrics = result.metrics;
                    resultDiv.innerHTML = `
                        <div class="alert alert-success" style="margin-top: 1rem;">Evaluation complete!</div>
                        <div class="result-box">
                            <div class="result-item">
                                <span class="result-label">Accuracy:</span>
                                <span class="result-value">${(metrics.accuracy * 100).toFixed(2)}%</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Precision:</span>
                                <span class="result-value">${(metrics.precision * 100).toFixed(2)}%</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Recall:</span>
                                <span class="result-value">${(metrics.recall * 100).toFixed(2)}%</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">F1 Score:</span>
                                <span class="result-value">${(metrics.f1 * 100).toFixed(2)}%</span>
                            </div>
                        </div>
                        ${result.confusion_matrix ? `<img src="data:image/png;base64,${result.confusion_matrix}" style="max-width: 100%; margin-top: 1rem; border-radius: 8px;">` : ''}
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger" style="margin-top: 1rem;">
                        <strong>Evaluation failed:</strong><br>
                        ${result.error}<br>
                        <small style="margin-top: 0.5rem; display: block;">
                            üí° Common issues:<br>
                            ‚Ä¢ Checkpoint file not found (check checkpoint name matches training)<br>
                            ‚Ä¢ CSV format mismatch (system will try to auto-map columns)<br>
                            ‚Ä¢ Check backend terminal for detailed error info
                        </small>
                    </div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger" style="margin-top: 1rem;">
                    <strong>Error:</strong> ${error.message}<br>
                    <small style="margin-top: 0.5rem; display: block;">
                        Check the backend terminal for detailed error information.
                    </small>
                </div>`;
            }
        }

        // Load remediation actions
        async function loadRemediationActions() {
            const listDiv = document.getElementById('remediation-list');
            listDiv.innerHTML = '<div class="spinner"></div>';

            try {
                const response = await fetch('/api/remediation/list');
                const actions = await response.json();

                if (!actions || actions.length === 0) {
                    listDiv.innerHTML = '<div class="empty-state"><p>No remediation actions recorded</p></div>';
                    return;
                }

                let html = '<table class="table"><thead><tr><th>ID</th><th>Type</th><th>Target</th><th>Status</th><th>Created</th></tr></thead><tbody>';
                
                actions.forEach(action => {
                    const time = new Date(action.created_at).toLocaleString();
                    html += `
                        <tr>
                            <td>#${action.id}</td>
                            <td>${action.type}</td>
                            <td>${JSON.stringify(action.details)}</td>
                            <td>${action.status}</td>
                            <td>${time}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                listDiv.innerHTML = html;
            } catch (error) {
                listDiv.innerHTML = `<div class="alert alert-danger">Error loading actions: ${error.message}</div>`;
            }
        }

        // Verify blockchain
        async function verifyBlockchain() {
            const resultDiv = document.getElementById('blockchain-result');
            resultDiv.innerHTML = '<div class="spinner"></div>';

            try {
                const response = await fetch('/api/blockchain/verify');
                const result = await response.json();

                if (result.exists) {
                    const statusClass = result.valid ? 'success' : 'danger';
                    const statusIcon = result.valid ? '‚úÖ' : '‚ùå';
                    
                    resultDiv.innerHTML = `
                        <div class="alert alert-${statusClass}" style="margin-top: 1rem;">
                            <strong>${statusIcon} Chain Integrity: ${result.valid ? 'VALID' : 'COMPROMISED'}</strong>
                        </div>
                        <div class="result-box">
                            <div class="result-item">
                                <span class="result-label">Chain Length:</span>
                                <span class="result-value">${result.length} blocks</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Last Block Hash:</span>
                                <span class="result-value" style="font-family: monospace; font-size: 0.75rem;">${result.last_hash || 'N/A'}</span>
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-warning" style="margin-top: 1rem;">No blockchain data found</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger" style="margin-top: 1rem;">Error: ${error.message}</div>`;
            }
        }

        // Analyze threats for a specific IP
        async function analyzeIPThreats() {
            const ip = document.getElementById('ip-analysis-input').value.trim();
            const resultDiv = document.getElementById('ip-analysis-result');
            resultDiv.innerHTML = '<div class="spinner"></div>';
            if (!ip) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Please enter an IP address.</div>';
                return;
            }
            try {
                const response = await fetch(`/api/threats_by_ip?ip=${encodeURIComponent(ip)}`);
                const result = await response.json();
                if (!result.success) {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${result.error}</div>`;
                    return;
                }
                if (!result.threats.length) {
                    resultDiv.innerHTML = '<div class="alert alert-info">No threats found for this IP.</div>';
                    return;
                }
                let html = `<h3>Threats for IP: ${ip}</h3><table class="table"><thead><tr><th>Type</th><th>Severity</th><th>Confidence</th><th>Timestamp</th></tr></thead><tbody>`;
                for (const t of result.threats) {
                    html += `<tr><td>${t.attack_type}</td><td>${t.severity}</td><td>${(t.confidence*100).toFixed(1)}%</td><td>${t.timestamp}</td></tr>`;
                }
                html += '</tbody></table>';
                resultDiv.innerHTML = html;
            } catch (err) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
            }
        }

        // Initialize on load
        window.addEventListener('load', initDashboard);

        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });

        // Start Realtime Detection (shows instructions)
        function startRealtimeDetection() {
            const iface = document.getElementById('realtime-iface').value.trim() || 'Ethernet';
            const windowSec = parseInt(document.getElementById('realtime-window').value) || 2;
            const resultDiv = document.getElementById('realtime-result');
            resultDiv.innerHTML = `<div class='alert alert-info'>
                <b>To start realtime detection:</b><br>
                <ol>
                  <li>Open PowerShell as Administrator</li>
                  <li>Activate your Python environment:<br>
                  <code>& .\\.venv\\Scripts\\Activate.ps1</code></li>
                  <li>Run this command:<br>
                  <code>python src/realtime.py --iface "${iface}" --window ${windowSec} --checkpoint checkpoints/best_iot23.pt --dataset iot23 --device cpu --dashboard http://localhost:8080</code></li>
                </ol>
                <b>Tip:</b> Use <code>Get-NetAdapter</code> in PowerShell to list available interfaces.<br>
                <b>Note:</b> You must have <a href='https://nmap.org/npcap/' target='_blank'>Npcap</a> installed for live capture on Windows.
            </div>`;
        }
    </script>
</body>
</html>
